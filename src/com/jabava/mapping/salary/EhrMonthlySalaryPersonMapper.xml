<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jabava.dao.salary.EhrMonthlySalaryPersonMapper" >
  <resultMap id="BaseResultMap" type="com.jabava.pojo.salary.EhrMonthlySalaryPerson" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 30 10:55:05 CST 2016.
    -->
    <id column="monthly_salary_person_id" property="monthlySalaryPersonId" jdbcType="BIGINT" />
    <result column="monthly_salary_id" property="monthlySalaryId" jdbcType="BIGINT" />
    <result column="person_id" property="personId" jdbcType="BIGINT" />
    <result column="person_name" property="personName" jdbcType="VARCHAR" />
    <result column="threshold" property="threshold" jdbcType="DECIMAL" />
    <result column="tax_rate" property="taxRate" jdbcType="DECIMAL" />
    <result column="fast_calculation_amount" property="fastCalculationAmount" jdbcType="DECIMAL" />
    <result column="yanglao_amount" property="yanglaoAmount" jdbcType="DECIMAL" />
    <result column="yiliao_amount" property="yiliaoAmount" jdbcType="DECIMAL" />
    <result column="shiye_amount" property="shiyeAmount" jdbcType="DECIMAL" />
    <result column="gongjijin_amount" property="gongjijinAmount" jdbcType="DECIMAL" />
    <result column="taxable_income" property="taxableIncome" jdbcType="DECIMAL" />
    <result column="taxable_he_income" property="taxableHeIncome" jdbcType="DECIMAL" />
    <result column="taxfree_income" property="taxfreeIncome" jdbcType="DECIMAL" />
    <result column="withholding_tax" property="withholdingTax" jdbcType="DECIMAL" />
    <result column="withholdinged_tax" property="withholdingedTax" jdbcType="DECIMAL" />
    <result column="after_tax_income" property="afterTaxIncome" jdbcType="DECIMAL" />
    <result column="take_home_income" property="takeHomeIncome" jdbcType="DECIMAL" />
    <result column="withholding_he_tax" property="withholdingHeTax" jdbcType="DECIMAL" />
    <result column="send_status" property="sendStatus" jdbcType="INTEGER" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 30 10:55:05 CST 2016.
    -->
    monthly_salary_person_id, monthly_salary_id, person_id, person_name, threshold, tax_rate, 
    fast_calculation_amount, yanglao_amount, yiliao_amount, shiye_amount, gongjijin_amount, 
    taxable_income, taxable_he_income, taxfree_income, withholding_tax, withholdinged_tax, 
    after_tax_income, take_home_income, withholding_he_tax, send_status
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 30 10:55:05 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    from ehr_monthly_salary_person
    where monthly_salary_person_id = #{monthlySalaryPersonId,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 30 10:55:05 CST 2016.
    -->
    delete from ehr_monthly_salary_person
    where monthly_salary_person_id = #{monthlySalaryPersonId,jdbcType=BIGINT}
    	${@com.jabava.utils.privilege.AuthorisedPersonUtil@getUserAuthorisedPersonList("person_id")}
  </delete>
  <insert id="insert" parameterType="com.jabava.pojo.salary.EhrMonthlySalaryPerson" 
  		useGeneratedKeys="true" keyProperty="monthlySalaryPersonId">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 30 10:55:05 CST 2016.
    -->
    insert into ehr_monthly_salary_person (monthly_salary_person_id, monthly_salary_id, 
      person_id, person_name, threshold, 
      tax_rate, fast_calculation_amount, yanglao_amount, 
      yiliao_amount, shiye_amount, gongjijin_amount, 
      taxable_income, taxable_he_income, taxfree_income, 
      withholding_tax, withholdinged_tax, after_tax_income, 
      take_home_income, withholding_he_tax, send_status)
    values (#{monthlySalaryPersonId,jdbcType=BIGINT}, #{monthlySalaryId,jdbcType=BIGINT}, 
      #{personId,jdbcType=BIGINT}, #{personName,jdbcType=VARCHAR}, #{threshold,jdbcType=DECIMAL}, 
      #{taxRate,jdbcType=DECIMAL}, #{fastCalculationAmount,jdbcType=DECIMAL}, #{yanglaoAmount,jdbcType=DECIMAL}, 
      #{yiliaoAmount,jdbcType=DECIMAL}, #{shiyeAmount,jdbcType=DECIMAL}, #{gongjijinAmount,jdbcType=DECIMAL}, 
      #{taxableIncome,jdbcType=DECIMAL}, #{taxableHeIncome,jdbcType=DECIMAL}, #{taxfreeIncome,jdbcType=DECIMAL}, 
      #{withholdingTax,jdbcType=DECIMAL}, #{withholdingedTax,jdbcType=DECIMAL}, #{afterTaxIncome,jdbcType=DECIMAL}, 
      #{takeHomeIncome,jdbcType=DECIMAL}, #{withholdingHeTax,jdbcType=DECIMAL}, #{sendStatus, jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" parameterType="com.jabava.pojo.salary.EhrMonthlySalaryPerson" 
  		useGeneratedKeys="true" keyProperty="monthlySalaryPersonId">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 30 10:55:05 CST 2016.
    -->
    insert into ehr_monthly_salary_person
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="monthlySalaryPersonId != null" >
        monthly_salary_person_id,
      </if>
      <if test="monthlySalaryId != null" >
        monthly_salary_id,
      </if>
      <if test="personId != null" >
        person_id,
      </if>
      <if test="personName != null" >
        person_name,
      </if>
      <if test="threshold != null" >
        threshold,
      </if>
      <if test="taxRate != null" >
        tax_rate,
      </if>
      <if test="fastCalculationAmount != null" >
        fast_calculation_amount,
      </if>
      <if test="yanglaoAmount != null" >
        yanglao_amount,
      </if>
      <if test="yiliaoAmount != null" >
        yiliao_amount,
      </if>
      <if test="shiyeAmount != null" >
        shiye_amount,
      </if>
      <if test="gongjijinAmount != null" >
        gongjijin_amount,
      </if>
      <if test="taxableIncome != null" >
        taxable_income,
      </if>
      <if test="taxableHeIncome != null" >
        taxable_he_income,
      </if>
      <if test="taxfreeIncome != null" >
        taxfree_income,
      </if>
      <if test="withholdingTax != null" >
        withholding_tax,
      </if>
      <if test="withholdingedTax != null" >
        withholdinged_tax,
      </if>
      <if test="afterTaxIncome != null" >
        after_tax_income,
      </if>
      <if test="takeHomeIncome != null" >
        take_home_income,
      </if>
      <if test="withholdingHeTax != null" >
        withholding_he_tax,
      </if>
      <if test="sendStatus != null" >
        send_status,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="monthlySalaryPersonId != null" >
        #{monthlySalaryPersonId,jdbcType=BIGINT},
      </if>
      <if test="monthlySalaryId != null" >
        #{monthlySalaryId,jdbcType=BIGINT},
      </if>
      <if test="personId != null" >
        #{personId,jdbcType=BIGINT},
      </if>
      <if test="personName != null" >
        #{personName,jdbcType=VARCHAR},
      </if>
      <if test="threshold != null" >
        #{threshold,jdbcType=DECIMAL},
      </if>
      <if test="taxRate != null" >
        #{taxRate,jdbcType=DECIMAL},
      </if>
      <if test="fastCalculationAmount != null" >
        #{fastCalculationAmount,jdbcType=DECIMAL},
      </if>
      <if test="yanglaoAmount != null" >
        #{yanglaoAmount,jdbcType=DECIMAL},
      </if>
      <if test="yiliaoAmount != null" >
        #{yiliaoAmount,jdbcType=DECIMAL},
      </if>
      <if test="shiyeAmount != null" >
        #{shiyeAmount,jdbcType=DECIMAL},
      </if>
      <if test="gongjijinAmount != null" >
        #{gongjijinAmount,jdbcType=DECIMAL},
      </if>
      <if test="taxableIncome != null" >
        #{taxableIncome,jdbcType=DECIMAL},
      </if>
      <if test="taxableHeIncome != null" >
        #{taxableHeIncome,jdbcType=DECIMAL},
      </if>
      <if test="taxfreeIncome != null" >
        #{taxfreeIncome,jdbcType=DECIMAL},
      </if>
      <if test="withholdingTax != null" >
        #{withholdingTax,jdbcType=DECIMAL},
      </if>
      <if test="withholdingedTax != null" >
        #{withholdingedTax,jdbcType=DECIMAL},
      </if>
      <if test="afterTaxIncome != null" >
        #{afterTaxIncome,jdbcType=DECIMAL},
      </if>
      <if test="takeHomeIncome != null" >
        #{takeHomeIncome,jdbcType=DECIMAL},
      </if>
      <if test="withholdingHeTax != null" >
        #{withholdingHeTax,jdbcType=DECIMAL},
      </if>
      <if test="sendStatus != null" >
        #{sendStatus,jdbcType=DECIMAL},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.jabava.pojo.salary.EhrMonthlySalaryPerson" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 30 10:55:05 CST 2016.
    -->
    update ehr_monthly_salary_person
    <set >
      <if test="monthlySalaryId != null" >
        monthly_salary_id = #{monthlySalaryId,jdbcType=BIGINT},
      </if>
      <if test="personId != null" >
        person_id = #{personId,jdbcType=BIGINT},
      </if>
      <if test="personName != null" >
        person_name = #{personName,jdbcType=VARCHAR},
      </if>
      <if test="threshold != null" >
        threshold = #{threshold,jdbcType=DECIMAL},
      </if>
      <if test="taxRate != null" >
        tax_rate = #{taxRate,jdbcType=DECIMAL},
      </if>
      <if test="fastCalculationAmount != null" >
        fast_calculation_amount = #{fastCalculationAmount,jdbcType=DECIMAL},
      </if>
      <if test="yanglaoAmount != null" >
        yanglao_amount = #{yanglaoAmount,jdbcType=DECIMAL},
      </if>
      <if test="yiliaoAmount != null" >
        yiliao_amount = #{yiliaoAmount,jdbcType=DECIMAL},
      </if>
      <if test="shiyeAmount != null" >
        shiye_amount = #{shiyeAmount,jdbcType=DECIMAL},
      </if>
      <if test="gongjijinAmount != null" >
        gongjijin_amount = #{gongjijinAmount,jdbcType=DECIMAL},
      </if>
      <if test="taxableIncome != null" >
        taxable_income = #{taxableIncome,jdbcType=DECIMAL},
      </if>
      <if test="taxableHeIncome != null" >
        taxable_he_income = #{taxableHeIncome,jdbcType=DECIMAL},
      </if>
      <if test="taxfreeIncome != null" >
        taxfree_income = #{taxfreeIncome,jdbcType=DECIMAL},
      </if>
      <if test="withholdingTax != null" >
        withholding_tax = #{withholdingTax,jdbcType=DECIMAL},
      </if>
      <if test="withholdingedTax != null" >
        withholdinged_tax = #{withholdingedTax,jdbcType=DECIMAL},
      </if>
      <if test="afterTaxIncome != null" >
        after_tax_income = #{afterTaxIncome,jdbcType=DECIMAL},
      </if>
      <if test="takeHomeIncome != null" >
        take_home_income = #{takeHomeIncome,jdbcType=DECIMAL},
      </if>
      <if test="withholdingHeTax != null" >
        withholding_he_tax = #{withholdingHeTax,jdbcType=DECIMAL},
      </if>
      <if test="sendStatus != null" >
        send_status = #{sendStatus,jdbcType=DECIMAL},
      </if>
    </set>
    where monthly_salary_person_id = #{monthlySalaryPersonId,jdbcType=BIGINT}
    	${@com.jabava.utils.privilege.AuthorisedPersonUtil@getUserAuthorisedPersonList("person_id")}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.jabava.pojo.salary.EhrMonthlySalaryPerson" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 30 10:55:05 CST 2016.
    -->
    update ehr_monthly_salary_person
    set monthly_salary_id = #{monthlySalaryId,jdbcType=BIGINT},
      person_id = #{personId,jdbcType=BIGINT},
      person_name = #{personName,jdbcType=VARCHAR},
      threshold = #{threshold,jdbcType=DECIMAL},
      tax_rate = #{taxRate,jdbcType=DECIMAL},
      fast_calculation_amount = #{fastCalculationAmount,jdbcType=DECIMAL},
      yanglao_amount = #{yanglaoAmount,jdbcType=DECIMAL},
      yiliao_amount = #{yiliaoAmount,jdbcType=DECIMAL},
      shiye_amount = #{shiyeAmount,jdbcType=DECIMAL},
      gongjijin_amount = #{gongjijinAmount,jdbcType=DECIMAL},
      taxable_income = #{taxableIncome,jdbcType=DECIMAL},
      taxable_he_income = #{taxableHeIncome,jdbcType=DECIMAL},
      taxfree_income = #{taxfreeIncome,jdbcType=DECIMAL},
      withholding_tax = #{withholdingTax,jdbcType=DECIMAL},
      withholdinged_tax = #{withholdingedTax,jdbcType=DECIMAL},
      after_tax_income = #{afterTaxIncome,jdbcType=DECIMAL},
      take_home_income = #{takeHomeIncome,jdbcType=DECIMAL},
      withholding_he_tax = #{withholdingHeTax,jdbcType=DECIMAL},
      send_status = #{sendStatus,jdbcType=DECIMAL}
    where monthly_salary_person_id = #{monthlySalaryPersonId,jdbcType=BIGINT}
    	${@com.jabava.utils.privilege.AuthorisedPersonUtil@getUserAuthorisedPersonList("person_id")}
  </update>
  
  <select id="getTaxHistory" resultType="java.util.HashMap">
  	select sum(msp.taxable_he_income) taxableHeIncome, sum(msp.withholding_he_tax) withholdingHeTax 
	from ehr_monthly_salary_person msp,ehr_monthly_salary ms 
	where msp.monthly_salary_id=ms.monthly_salary_id and 
		ms.monthly=#{monthly,jdbcType=VARCHAR} and 
		ms.last_flag=1 and ms.monthly_salary_id <![CDATA[<>]]> #{monthlySalaryId,jdbcType=BIGINT} and 
		msp.person_id=#{personId,jdbcType=BIGINT}
  </select>
  <select id="selectByMonthlySalaryIdPage" resultMap="BaseResultMap">
  	select * from ehr_monthly_salary_person 
  	where monthly_salary_id=#{monthlySalaryId,jdbcType=BIGINT}
  		${@com.jabava.utils.privilege.AuthorisedPersonUtil@getUserAuthorisedPersonList("person_id")}
  </select>
  <select id="selectByMonthlySalaryId" resultType="java.util.HashMap">
  	SELECT msp.*,p.employee_name,p.cert_type,p.cert_id,p.bank_name,p.salary_card
	FROM ehr_monthly_salary_person msp LEFT JOIN ehr_person p ON msp.person_id=p.person_id
	WHERE msp.monthly_salary_id=#{monthlySalaryId,jdbcType=BIGINT}
		${@com.jabava.utils.privilege.AuthorisedPersonUtil@getUserAuthorisedPersonList("msp.person_id")}
  </select>
  <select id="listPayoffHistoryPage" resultType="java.util.HashMap">
  	SELECT msp.*, p.job_number,p.employee_name,p.cert_id,ms.monthly,ms.review_status
	FROM ehr_monthly_salary_person msp 
		LEFT JOIN ehr_monthly_salary ms ON msp.monthly_salary_id=ms.monthly_salary_id
		LEFT JOIN ehr_person p ON msp.person_id=p.person_id
	WHERE ms.company_id=#{companyId,jdbcType=BIGINT} AND ms.last_flag=1 
		AND msp.person_id=#{personId,jdbcType=BIGINT} AND ms.usage_flag=#{usageFlag,jdbcType=BIGINT} 
		<if test="startMonth != null and startMonth != ''" >
			AND monthly<![CDATA[>=]]>#{startMonth,jdbcType=VARCHAR} 
		</if>
		<if test="endMonth != null and endMonth != ''" >
			AND monthly<![CDATA[<=]]>#{endMonth,jdbcType=VARCHAR} 
		</if>
	ORDER BY ms.monthly
  </select>
  
  <select id="queryByCertIdAndMonth" resultType="java.util.HashMap">
  	SELECT msp.monthly_salary_person_id monthlySalaryPersonId, p.employee_name employeeName, 
		taxable_income taxableIncome, withholding_tax withholdingTax, 
		after_tax_income afterTaxIncome, take_home_income takeHomeIncome
	FROM ehr_monthly_salary_person msp LEFT JOIN ehr_monthly_salary ms ON msp.monthly_salary_id=ms.monthly_salary_id
	LEFT JOIN ehr_person p ON msp.person_id=p.person_id
	WHERE ms.last_flag=1 AND ms.monthly=#{month} AND 
		p.cert_id=#{cardId} AND p.is_deleted=0
  </select>
  
  <select id="queryPersonsForSalarySlip" resultType="java.util.HashMap">
  	SELECT msp.*, p.job_number, p.employee_name, p.email, p.email_e 
  	FROM ehr_monthly_salary_person msp
		LEFT JOIN ehr_monthly_salary ms ON msp.monthly_salary_id=ms.monthly_salary_id
		LEFT JOIN ehr_person p ON msp.person_id=p.person_id
	WHERE ms.monthly_salary_id=#{monthlySalaryId,jdbcType=BIGINT} 
	<if test="sendStatus != null" >
		AND msp.send_status=#{sendStatus,jdbcType=INTEGER}
	</if>
	<if test="personIds != null" >
		AND msp.person_id in (#{personIds})
	</if>
  </select>
  
  <update id="updateSendStatus">
  	update ehr_monthly_salary_person
  	set send_status=#{sendStatus,jdbcType=INTEGER}
  	where monthly_salary_person_id=#{monthlySalaryPersonId,jdbcType=BIGINT}
  </update>
</mapper>