<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jabava.dao.hro.HroEfArapMapper" >
  <resultMap id="BaseResultMap" type="com.jabava.pojo.hro.HroEfArap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 27 11:32:20 CST 2016.
    -->
    <id column="BILL_ID" property="billId" jdbcType="BIGINT" />
    <result column="ORG_ID" property="orgId" jdbcType="BIGINT" />
    <result column="VERSION" property="version" jdbcType="INTEGER" />
    <result column="BILL_TYPE" property="billType" jdbcType="INTEGER" />
    <result column="BILL_CODE" property="billCode" jdbcType="VARCHAR" />
    <result column="PAYEE_ID" property="payeeId" jdbcType="BIGINT" />
    <result column="PAYER_ID" property="payerId" jdbcType="BIGINT" />
    <result column="BILL_YM" property="billYm" jdbcType="CHAR" />
    <result column="BILL_TEMPLATE_ID" property="billTemplateId" jdbcType="BIGINT" />
    <result column="STATUS_BILL" property="statusBill" jdbcType="VARCHAR" />
    <result column="STATUS_IV" property="statusIv" jdbcType="VARCHAR" />
    <result column="STATUS_VERIFY" property="statusVerify" jdbcType="VARCHAR" />
    <result column="DATE_BILL_CREATE_FIRST" property="dateBillCreateFirst" jdbcType="TIMESTAMP" />
    <result column="DATE_BILL_CREATE" property="dateBillCreate" jdbcType="TIMESTAMP" />
    <result column="DATE_BILL_CONFIRM" property="dateBillConfirm" jdbcType="TIMESTAMP" />
    <result column="PAY_DAY" property="payDay" jdbcType="DATE" />
    <result column="PAYMENT_SETTLEMENT" property="paymentSettlement" jdbcType="INTEGER" />
    <result column="AMOUNT_TOTAL" property="amountTotal" jdbcType="DECIMAL" />
    <result column="AMOUNT" property="amount" jdbcType="DECIMAL" />
    <result column="AMOUNT_ADJ" property="amountAdj" jdbcType="DECIMAL" />
    <result column="AMOUNT_ADJ_IV" property="amountAdjIv" jdbcType="DECIMAL" />
    <result column="AMOUNT_ADJ_VERIFY" property="amountAdjVerify" jdbcType="DECIMAL" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="IS_DELETED" property="isDeleted" jdbcType="INTEGER" />
    <result column="CREATE_BY" property="createBy" jdbcType="BIGINT" />
    <result column="CREATE_DT" property="createDt" jdbcType="TIMESTAMP" />
    <result column="UPDATE_BY" property="updateBy" jdbcType="BIGINT" />
    <result column="UPDATE_DT" property="updateDt" jdbcType="TIMESTAMP" />
    <result column="MIMIC_BY" property="mimicBy" jdbcType="BIGINT" />
    <result column="PROXY_BY" property="proxyBy" jdbcType="BIGINT" />
    <result column="TOTAL_SB_AMOUNT_E" property="totalSbAmountE" jdbcType="DECIMAL" />
    <result column="TOTAL_SB_AMOUNT_P" property="totalSbAmountP" jdbcType="DECIMAL" />
    <result column="TOTAL_EXTRA_AMOUNT" property="totalExtraAmount" jdbcType="DECIMAL" />
    <result column="TOTAL_NSB_AMOUNT" property="totalNsbAmount" jdbcType="DECIMAL" />
    <result column="TOTAL_WITHOUTSUM_AMOUNT" property="totalWithoutsumAmount" jdbcType="DECIMAL" />
    <result column="TOTAL_AGENT_AMOUNT" property="totalAgentAmount" jdbcType="DECIMAL" />
    <result column="TOTAL_NOTAGENT_AMOUNT" property="totalNotagentAmount" jdbcType="DECIMAL" />
    <result column="DATE_BILL_CANCEL" property="dateBillCancel" jdbcType="TIMESTAMP" />
    <result column="HAS_VOUCHER_CONFIRM" property="hasVoucherConfirm" jdbcType="INTEGER" />
    <result column="ARAP_TYPE" property="arapType" jdbcType="INTEGER" />
    <result column="SERVER_YM" property="serverYm" jdbcType="VARCHAR" />
    <result column="PERSON_NUM" property="personNum" jdbcType="INTEGER" />
    <result column="PERSON_TRIP" property="personTrip" jdbcType="INTEGER" />
    <result column="HR_STATUS" property="hrStatus" jdbcType="INTEGER" />
    <result column="HR_DATE" property="hrDate" jdbcType="TIMESTAMP" />
    <result column="HR_REJECT_REMARK" property="hrRejectRemark" jdbcType="VARCHAR" />
    <result column="PAY_LINK" property="payLink" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="ResultMapWithBLOBs" type="com.jabava.pojo.hro.HroEfArap" extends="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 27 11:32:20 CST 2016.
    -->
    <result column="CONCAT_DETAIL_ID" property="concatDetailId" jdbcType="LONGVARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 27 11:32:20 CST 2016.
    -->
    BILL_ID, ORG_ID, VERSION, BILL_TYPE, BILL_CODE, PAYEE_ID, PAYER_ID, BILL_YM, BILL_TEMPLATE_ID, 
    STATUS_BILL, STATUS_IV, STATUS_VERIFY, DATE_BILL_CREATE_FIRST, DATE_BILL_CREATE, 
    DATE_BILL_CONFIRM, PAY_DAY, PAYMENT_SETTLEMENT, AMOUNT_TOTAL, AMOUNT, AMOUNT_ADJ, 
    AMOUNT_ADJ_IV, AMOUNT_ADJ_VERIFY, REMARK, IS_DELETED, CREATE_BY, CREATE_DT, UPDATE_BY, 
    UPDATE_DT, MIMIC_BY, PROXY_BY, TOTAL_SB_AMOUNT_E, TOTAL_SB_AMOUNT_P, TOTAL_EXTRA_AMOUNT, 
    TOTAL_NSB_AMOUNT, TOTAL_WITHOUTSUM_AMOUNT, TOTAL_AGENT_AMOUNT, TOTAL_NOTAGENT_AMOUNT, 
    DATE_BILL_CANCEL, HAS_VOUCHER_CONFIRM, ARAP_TYPE, SERVER_YM, PERSON_NUM, 
    PERSON_TRIP, HR_STATUS, HR_DATE, HR_REJECT_REMARK, PAY_LINK
  </sql>
  <sql id="Blob_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 27 11:32:20 CST 2016.
    -->
    CONCAT_DETAIL_ID
  </sql>
  <select id="selectByPrimaryKey" resultMap="ResultMapWithBLOBs" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 27 11:32:20 CST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from hr.EF_ARAP
    where BILL_ID = #{billId,jdbcType=BIGINT}
  </select>
  
  <select id="selectBill" resultType="java.util.HashMap">
    select distinct bill.*, t.BILL_TEMPLATE_NAME, t.PAYMENT_DAY, t.PAYMENT_LOCK_DAY, 
    	(SELECT MAX(v.CONFIRM_DATE) FROM hr.EF_RECEIP_VERIFY_BILL_DETAIL vb 
			LEFT JOIN hr.EF_RECEIP_VERIFY v ON vb.VERIFY_ID=v.VERIFY_ID 
		WHERE vb.BILL_ID=bill.BILL_ID AND vb.BILL_CODE=bill.BILL_CODE) CONFIRM_DATE 
	from hr.API_PROTOCOL_CODE_INFO p 
		inner join hr.EF_ARAP bill on bill.PAYER_ID=p.CLIENT_ID and bill.PAYEE_ID=p.RECEIVE_ORG_ID 
		inner join hr.BD_BILL_TEMPLATE t on bill.BILL_TEMPLATE_ID=t.BILL_TEMPLATE_ID 
	where bill.IS_DELETED=0 and bill.HR_STATUS in (1,2,3,4) 
	    <if test="year != null" >
	    	AND left(bill.BILL_YM,4)=#{year,jdbcType=VARCHAR} 
	    </if>
	    <if test="protocolList!=null and protocolList.size()>0">
		    and p.PROTOCOL_CODE in
			<foreach item="item" index="index" collection="protocolList" open="(" separator="," close=")">
	            #{item.pactCode}
	        </foreach>
         </if>
         <!-- 如果不存在协议号，应该查不到数据，而不应该忽略此条件 -->
         <if test="protocolList==null or protocolList.size()==0">
         	and p.PROTOCOL_CODE in ('')
         </if>
	  	order by BILL_YM desc
  </select>
</mapper>